#!/bin/bash
# VDO.Ninja Intercom Launcher - PipeWire only

# PipeWire is required
if ! command -v pipewire &> /dev/null || ! command -v wireplumber &> /dev/null; then
    echo "ERROR: PipeWire and WirePlumber are required but not installed"
    echo "Please run: apt-get install pipewire pipewire-pulse wireplumber"
    exit 1
fi

# Wait for user session PipeWire to be ready
# The service runs as mediabridge user already, so check directly
export XDG_RUNTIME_DIR="/run/user/999"
export USER="mediabridge"
export HOME="/var/lib/mediabridge"

for i in {1..10}; do
    if systemctl --user is-active --quiet pipewire.service && \
       systemctl --user is-active --quiet pipewire-pulse.service; then
        echo "User session PipeWire is ready"
        break
    fi
    echo "Waiting for user session PipeWire... (attempt $i)"
    sleep 1
done

echo "Starting Media Bridge Intercom with PipeWire..."
exec /usr/local/bin/media-bridge-intercom-pipewire "$@"