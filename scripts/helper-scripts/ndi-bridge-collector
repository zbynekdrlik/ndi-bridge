#!/bin/bash
# NDI Bridge Status Collector
# Runs as a service to collect metrics for the welcome screen

# Create runtime directory
mkdir -p /var/run/ndi-bridge

# Track service start time for stabilization period
SERVICE_START_FILE="/var/run/ndi-bridge/capture_start_time"

# Main collection loop
while true; do
    # Check if we're in stabilization period
    IS_STABILIZING=false
    if [ -f "$SERVICE_START_FILE" ] && systemctl is-active --quiet ndi-capture; then
        START_TIME=$(cat "$SERVICE_START_FILE")
        CURRENT_TIME=$(date +%s)
        ELAPSED=$((CURRENT_TIME - START_TIME))
        if [ "$ELAPSED" -lt 60 ]; then
            IS_STABILIZING=true
        fi
    fi
    
    # 1. Get current FPS from last metrics entry (only if recent)
    METRICS_LINE=$(journalctl -u ndi-capture -n 200 --no-pager 2>/dev/null | grep "METRICS|" | tail -1)
    if [ -n "$METRICS_LINE" ]; then
        # Extract timestamp and check if recent (within 5 seconds)
        METRICS_TIME=$(echo "$METRICS_LINE" | cut -d' ' -f1-3)
        if [ -n "$METRICS_TIME" ]; then
            METRICS_EPOCH=$(date -d "$METRICS_TIME" +%s 2>/dev/null || echo "0")
            NOW_EPOCH=$(date +%s)
            AGE=$((NOW_EPOCH - METRICS_EPOCH))
            
            # Only use metrics if less than 5 seconds old
            if [ "$AGE" -lt 5 ]; then
                FPS=$(echo "$METRICS_LINE" | sed -n 's/.*FPS:\([0-9.]*\).*/\1/p')
                FRAMES=$(echo "$METRICS_LINE" | sed -n 's/.*FRAMES:\([0-9]*\).*/\1/p')
                DROPPED=$(echo "$METRICS_LINE" | sed -n 's/.*DROPPED:\([0-9]*\).*/\1/p')
                LATENCY=$(echo "$METRICS_LINE" | sed -n 's/.*LATENCY:\([0-9.]*\).*/\1/p')
                
                echo "$FPS" > /var/run/ndi-bridge/fps_current
                echo "$FRAMES" > /var/run/ndi-bridge/frames_total
                
                # During stabilization, don't count dropped frames
                if [ "$IS_STABILIZING" = true ]; then
                    echo "0" > /var/run/ndi-bridge/frames_dropped
                else
                    echo "$DROPPED" > /var/run/ndi-bridge/frames_dropped
                fi
                
                [ -n "$LATENCY" ] && echo "$LATENCY" > /var/run/ndi-bridge/latency_ms
            else
                # Metrics are stale - clear them
                echo "0.00" > /var/run/ndi-bridge/fps_current
                echo "0" > /var/run/ndi-bridge/frames_total
                echo "0" > /var/run/ndi-bridge/frames_dropped
                echo "N/A" > /var/run/ndi-bridge/latency_ms
            fi
        fi
    fi
    
    # 2. Get 10-minute FPS history and calculate average
    # During stabilization, only collect FPS stats but don't count issues
    FPS_HISTORY=$(journalctl -u ndi-capture --since "10 minutes ago" --no-pager 2>/dev/null | grep "METRICS|" | sed -n 's/.*FPS:\([0-9.]*\).*/\1/p')
    if [ -n "$FPS_HISTORY" ]; then
        # Calculate average
        AVG_FPS=$(echo "$FPS_HISTORY" | awk '{sum+=$1; count++} END {if(count>0) printf "%.2f", sum/count; else print "0"}')
        echo "$AVG_FPS" > /var/run/ndi-bridge/fps_10min_avg
        
        # Find min/max
        MIN_FPS=$(echo "$FPS_HISTORY" | sort -n | head -1)
        MAX_FPS=$(echo "$FPS_HISTORY" | sort -n | tail -1)
        echo "$MIN_FPS" > /var/run/ndi-bridge/fps_10min_min
        echo "$MAX_FPS" > /var/run/ndi-bridge/fps_10min_max
        
        # Count issues (FPS < 55) - but not during stabilization
        if [ "$IS_STABILIZING" = true ]; then
            echo "0" > /var/run/ndi-bridge/fps_issues
        else
            ISSUES=$(echo "$FPS_HISTORY" | awk '$1 < 55' | wc -l)
            echo "$ISSUES" > /var/run/ndi-bridge/fps_issues
        fi
    fi
    
    # 3. Monitor network TX rate on br0
    if [ -f /sys/class/net/br0/statistics/tx_bytes ]; then
        TX_BYTES_1=$(cat /sys/class/net/br0/statistics/tx_bytes)
        sleep 1
        TX_BYTES_2=$(cat /sys/class/net/br0/statistics/tx_bytes)
        
        # Calculate Mbps
        BYTES_DIFF=$((TX_BYTES_2 - TX_BYTES_1))
        MBPS=$(echo "scale=1; $BYTES_DIFF * 8 / 1000000" | bc 2>/dev/null || echo "0")
        echo "$MBPS" > /var/run/ndi-bridge/network_mbps
    else
        echo "0" > /var/run/ndi-bridge/network_mbps
    fi
    
    # 4. Check capture state and device status
    # First check if the configured device exists
    DEVICE=$(cat /etc/ndi-bridge/config 2>/dev/null | grep DEVICE | cut -d'"' -f2 || echo "/dev/video0")
    
    if [ ! -e "$DEVICE" ]; then
        # Device doesn't exist
        echo "NO_DEVICE" > /var/run/ndi-bridge/capture_state
    elif systemctl is-active --quiet ndi-capture; then
        # Check if this is a fresh start (service just became active)
        if [ ! -f "$SERVICE_START_FILE" ]; then
            # Record the start time
            date +%s > "$SERVICE_START_FILE"
        fi
        
        # Check if we're in stabilization period (first 60 seconds)
        if [ -f "$SERVICE_START_FILE" ]; then
            START_TIME=$(cat "$SERVICE_START_FILE")
            CURRENT_TIME=$(date +%s)
            ELAPSED=$((CURRENT_TIME - START_TIME))
            
            if [ "$ELAPSED" -lt 60 ]; then
                # Still stabilizing
                echo "STABILIZING" > /var/run/ndi-bridge/capture_state
                echo "$ELAPSED" > /var/run/ndi-bridge/stabilizing_seconds
                # Skip the rest of the checks during stabilization
                sleep 1
                continue
            else
                # Stabilization complete - clean up the seconds file
                rm -f /var/run/ndi-bridge/stabilizing_seconds
            fi
        fi
        # Service is running, check if actually capturing (has recent metrics)
        LAST_METRIC_TIME=$(journalctl -u ndi-capture -n 10 --no-pager 2>/dev/null | grep "METRICS|" | tail -1 | cut -d' ' -f1-3)
        if [ -n "$LAST_METRIC_TIME" ]; then
            # Check if metric is recent (within last 5 seconds)
            LAST_EPOCH=$(date -d "$LAST_METRIC_TIME" +%s 2>/dev/null || echo "0")
            NOW_EPOCH=$(date +%s)
            DIFF=$((NOW_EPOCH - LAST_EPOCH))
            
            if [ "$DIFF" -lt 5 ]; then
                echo "CAPTURING" > /var/run/ndi-bridge/capture_state
            else
                # Check for recent errors
                RECENT_ERROR=$(journalctl -u ndi-capture -n 5 --no-pager 2>/dev/null | grep -E "ERROR|Failed to open device")
                if [ -n "$RECENT_ERROR" ]; then
                    echo "ERROR" > /var/run/ndi-bridge/capture_state
                else
                    echo "IDLE" > /var/run/ndi-bridge/capture_state
                fi
            fi
        else
            echo "STARTING" > /var/run/ndi-bridge/capture_state
        fi
    else
        echo "STOPPED" > /var/run/ndi-bridge/capture_state
        # Clear the start time when service stops
        rm -f "$SERVICE_START_FILE"
        rm -f /var/run/ndi-bridge/stabilizing_seconds
    fi
    
    # 5. Get NDI stream name from config
    if [ -f /etc/ndi-bridge/config ]; then
        source /etc/ndi-bridge/config
        echo "$NDI_NAME" > /var/run/ndi-bridge/stream_name
    fi
    
    # Wait before next collection (total loop ~2 seconds)
    sleep 1
done