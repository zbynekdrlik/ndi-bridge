#!/bin/bash
# Show Dante audio bridge status

echo "================================"
echo "    Dante Audio Bridge Status   "
echo "================================"
echo

# Check if Statime PTP daemon is running
STATIME_STATUS=$(systemctl is-active statime.service 2>/dev/null)
if [ "$STATIME_STATUS" = "active" ]; then
    echo -e "PTP Daemon: \033[32mRUNNING\033[0m"
else
    echo -e "PTP Daemon: \033[31mSTOPPED\033[0m"
fi

# Check if Inferno ALSA service is running
INFERNO_STATUS=$(systemctl is-active inferno-alsa.service 2>/dev/null)
if [ "$INFERNO_STATUS" = "active" ]; then
    echo -e "Inferno ALSA: \033[32mRUNNING\033[0m"
    
    # Check if listening on Dante ports
    DANTE_PORTS=$(netstat -ulnp 2>/dev/null | grep -E '8700|8800' | wc -l)
    if [ "$DANTE_PORTS" -gt 0 ]; then
        echo "  Dante ports: Active (8700, 8800)"
    fi
else
    echo -e "Inferno ALSA: \033[31mSTOPPED\033[0m"
fi

# Check USB to Dante bridge
USB_BRIDGE_STATUS=$(systemctl is-active usb-dante-bridge.service 2>/dev/null)
if [ "$USB_BRIDGE_STATUS" = "active" ]; then
    echo -e "USB Bridge: \033[32mRUNNING\033[0m"
    # Find which USB card is being used
    USB_CARD=$(ps aux | grep -E "arecord.*plughw:" | grep -v grep | sed 's/.*plughw:\([0-9]\).*/\1/' | head -1)
    if [ -n "$USB_CARD" ]; then
        USB_NAME=$(aplay -l | grep "^card $USB_CARD:" | sed 's/card [0-9]: //' | cut -d',' -f1)
        echo "  USB Device: $USB_NAME"
    fi
else
    echo -e "USB Bridge: \033[33mNOT ACTIVE\033[0m"
fi

echo

# Show configuration
if [ -f /etc/ndi-bridge/dante.conf ]; then
    echo "Configuration:"
    echo "--------------"
    source /etc/ndi-bridge/dante.conf
    DEVICE_NAME=${DANTE_DEVICE_NAME:-${HOSTNAME:-ndi-bridge}}
    echo "  Device Name: $DEVICE_NAME"
    echo "  Interface: ${DANTE_INTERFACE:-br0}"
    echo "  Channels: ${DANTE_CHANNELS:-2}"
    echo "  Sample Rate: ${DANTE_SAMPLE_RATE:-96000} Hz"
    echo "  Mode: ${DANTE_MODE:-bidirectional}"
else
    echo "Configuration file not found"
fi

echo

# Check network interface
INTERFACE=${DANTE_INTERFACE:-br0}
if ip link show $INTERFACE &>/dev/null; then
    echo "Network Interface ($INTERFACE):"
    echo "----------------------------"
    IP_ADDR=$(ip -4 addr show $INTERFACE | grep inet | awk '{print $2}')
    echo "  IP Address: ${IP_ADDR:-Not configured}"
    
    # Check multicast support (required for Dante)
    MULTICAST=$(ip link show $INTERFACE | grep -o "MULTICAST")
    if [ -n "$MULTICAST" ]; then
        echo -e "  Multicast: \033[32mEnabled\033[0m"
    else
        echo -e "  Multicast: \033[31mDisabled\033[0m (Required for Dante)"
    fi
fi

echo

# Check for USB audio devices
echo "USB Audio Devices:"
echo "-----------------"
USB_DEVICES=$(aplay -l | grep -E "USB Audio|Arturia|Behringer|Focusrite|Scarlett" | wc -l)
if [ "$USB_DEVICES" -gt 0 ]; then
    aplay -l | grep -E "USB Audio|Arturia|Behringer|Focusrite|Scarlett" | while read line; do
        echo "  $line"
    done
else
    echo "  No USB audio devices found"
fi

echo
echo "Use 'ndi-bridge-dante-config' to modify settings"
echo "Use 'ndi-bridge-dante-logs' to view logs"