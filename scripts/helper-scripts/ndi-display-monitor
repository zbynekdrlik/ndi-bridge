#!/bin/bash
# Monitor HDMI connections and write status

while true; do
    # Check if ndi-display binary exists
    if [ -x /opt/media-bridge/ndi-display ]; then
        # Create status directory if needed
        mkdir -p /var/run/ndi-display 2>/dev/null || mkdir -p /tmp/ndi-display
        
        # Use appropriate directory
        STATUS_DIR="/var/run/ndi-display"
        if [ ! -w "$STATUS_DIR" ]; then
            STATUS_DIR="/tmp/ndi-display"
        fi
        
        # Get display connections and write to file
        /opt/media-bridge/ndi-display displays 2>/dev/null > "${STATUS_DIR}/hdmi-connections.tmp"
        
        # Parse the output and create simple status files
        for i in 0 1 2; do
            HDMI_NUM=$((i + 1))
            CONNECTION_FILE="${STATUS_DIR}/hdmi-${i}.connection"
            
            # Check if display is connected from the output
            # Looking for format: "Display 0: HDMI-A-1 [1920x1080 @ 60Hz]"
            if grep -q "Display ${i}:.*\[.*x.*Hz\]" "${STATUS_DIR}/hdmi-connections.tmp" 2>/dev/null; then
                # Extract resolution and refresh rate with better parsing
                LINE=$(grep "Display ${i}:" "${STATUS_DIR}/hdmi-connections.tmp")
                RESOLUTION=$(echo "$LINE" | sed -n 's/.*\[\([0-9]*x[0-9]*\).*/\1/p')
                REFRESH=$(echo "$LINE" | sed -n 's/.*@ \([0-9.]*\)Hz.*/\1/p')
                
                echo "CONNECTED=true" > "$CONNECTION_FILE"
                echo "RESOLUTION=$RESOLUTION" >> "$CONNECTION_FILE"
                echo "REFRESH_RATE=$REFRESH" >> "$CONNECTION_FILE"
                echo "HDMI_PORT=$HDMI_NUM" >> "$CONNECTION_FILE"
                echo "TIMESTAMP=$(date +%s)" >> "$CONNECTION_FILE"
            else
                echo "CONNECTED=false" > "$CONNECTION_FILE"
                echo "HDMI_PORT=$HDMI_NUM" >> "$CONNECTION_FILE"
                echo "TIMESTAMP=$(date +%s)" >> "$CONNECTION_FILE"
            fi
        done
        
        # Clean up temp file
        rm -f "${STATUS_DIR}/hdmi-connections.tmp"
    fi
    
    # Sleep for 5 seconds before next check
    sleep 5
done