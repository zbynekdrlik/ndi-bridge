-- WirePlumber configuration for Media Bridge Intercom
-- Creates virtual devices for Chrome isolation in user mode

-- Load the virtual device creation script
table.insert(alsa_monitor.rules, {
  matches = {},
  apply_properties = {},
})

-- Create virtual null sinks for intercom isolation
load_script("create-item.lua", {
  ["create-item.items"] = {
    {
      ["factory"] = "adapter",
      ["type"] = "pw-module-null-sink",
      ["args"] = {
        ["node.name"] = "intercom-speaker",
        ["node.description"] = "Intercom Speaker (Virtual)",
        ["media.class"] = "Audio/Sink",
        ["audio.position"] = "FL,FR",
        ["audio.channels"] = 2,
        ["audio.rate"] = 48000,
      },
    },
    {
      ["factory"] = "adapter",
      ["type"] = "pw-module-null-sink",
      ["args"] = {
        ["node.name"] = "intercom-microphone",
        ["node.description"] = "Intercom Microphone (Virtual)",
        ["media.class"] = "Audio/Sink",
        ["audio.position"] = "FL,FR",
        ["audio.channels"] = 2,
        ["audio.rate"] = 48000,
      },
    },
  },
})

-- Create loopback connections to USB hardware
load_script("link-nodes.lua", {
  ["link-nodes.items"] = {
    -- Link virtual speaker monitor to USB output
    {
      ["source.node"] = "intercom-speaker",
      ["source.port"] = "monitor",
      ["target.node"] = "~alsa_output.*CSCTEK_USB_Audio.*",
      ["target.port"] = "playback_FL,playback_FR",
      ["passthrough"] = false,
    },
    -- Link USB input to virtual microphone
    {
      ["source.node"] = "~alsa_input.*CSCTEK_USB_Audio.*",
      ["source.port"] = "capture_FL,capture_FR",
      ["target.node"] = "intercom-microphone",
      ["target.port"] = "playback_FL,playback_FR",
      ["passthrough"] = false,
    },
  },
})

-- Chrome audio routing policy
-- Automatically route Chrome to virtual devices
default_policy.policy["move"] = {
  ["application.process.binary"] = {
    ["chrome"] = {
      ["media.role"] = "Communication",
      ["target.node"] = "intercom-speaker",
      ["target.source"] = "intercom-microphone.monitor",
    },
    ["google-chrome"] = {
      ["media.role"] = "Communication",
      ["target.node"] = "intercom-speaker",
      ["target.source"] = "intercom-microphone.monitor",
    },
  },
}